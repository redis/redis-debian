# This workflow runs on regular PR/push to branches
# and is workflow_call'ed by nightly-unstable-package.yaml
# schedule to build unstable release
# The main purpose of the workflow to determine whether we need
# to use "unstable" release_tag
# The actual job dispatch is done by build-n-test-all-distros.yml

name: Build

on:
  pull_request:
    branches:
    - master
    - release/*
    - unstable
  push:
    branches:
    - master
    - release/*
    - unstable
  workflow_dispatch:
  workflow_call:

run-name: >-
        ${{ (github.ref_name == 'unstable'
        || github.event_name == 'workflow_dispatch'
        || github.event_name == 'workflow_call')
        && 'Build Unstable'
        || format('Build on {0} to {1}', github.event_name, github.ref_name)
        }}

jobs:
  build-n-test:
    uses: ./.github/workflows/build-n-test-all-distros.yml
    with:
      BUILD_DISTS: ${{ vars.BUILD_DISTS }}
      BUILD_ARCHS: ${{ vars.BUILD_ARCHS }}
      BUILD_EXCLUDE: ${{ vars.BUILD_EXCLUDE }}
      SMOKE_TEST_IMAGES: ${{ vars.SMOKE_TEST_IMAGES }}
      # determine whether we should use special "unstable" release_tag
      # Assume that for unstable branch and for any external call or dispatch
      # we are building unstable release
      # In other cases it's a regular PR/push build
      release_tag: >-
        ${{ (github.ref_name == 'unstable'
        || github.event_name == 'workflow_dispatch'
        || github.event_name == 'workflow_call')
        && 'unstable'
        || ''
        }}